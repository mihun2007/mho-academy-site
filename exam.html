<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimitere Examen - MHO Music Academy</title>
    <link rel="icon" type="image/png" href="Logo MHO Academy.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold">üéµ MHO Music Academy</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="index.html" class="hover:bg-amber-700 px-4 py-2 rounded-lg transition">AcasƒÉ</a>
                    <a href="register.html" class="hover:bg-amber-700 px-4 py-2 rounded-lg transition">√énregistrare</a>
                    <a href="exam.html" class="bg-amber-700 px-4 py-2 rounded-lg">Examen</a>
                    <a href="admin.html" class="hover:bg-amber-700 px-4 py-2 rounded-lg transition">Admin</a>
                    <a href="noutati.html" class="hover:bg-amber-700 px-4 py-2 rounded-lg transition">NoutƒÉ»õi</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-3xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Trimitere Examen</h2>
            <p class="text-gray-600 mb-8">Trimite fi»ôierele »ôi informa»õiile tale pentru examen</p>

            <!-- Status Message -->
            <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

            <!-- Exam Form -->
            <form id="examForm" class="space-y-6">
                <!-- Name Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">
                            Nume <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="firstName" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            placeholder="Introduce»õi numele"
                        >
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">
                            Prenume <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="lastName" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            placeholder="Introduce»õi prenumele"
                        >
                    </div>
                </div>

                <!-- Course and Group -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="course" class="block text-sm font-medium text-gray-700 mb-2">
                            Curs <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="course" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        >
                            <option value="">Selecta»õi cursul...</option>
                            <option value="ORNI">ORNI</option>
                            <option value="Coarde">Coarde</option>
                            <option value="Aerofone">Aerofone</option>
                            <option value="Dirijor">Dirijor</option>
                        </select>
                    </div>
                    <div>
                        <label for="group" class="block text-sm font-medium text-gray-700 mb-2">
                            GrupƒÉ <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="group" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        >
                            <option value="">Selecta»õi grupa...</option>
                            <option value="G">G</option>
                            <option value="B">B</option>
                            <option value="V">V</option>
                            <option value="A">A</option>
                            <option value="Armonie">Armonie</option>
                        </select>
                    </div>
                </div>

                <!-- Download Exam Files Section -->
                <div id="downloadSection" class="hidden bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border-2 border-blue-200">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-blue-500 rounded-full p-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800">DescarcƒÉ Fi»ôierele de Examen</h3>
                            <p class="text-sm text-gray-600">ApasƒÉ mai jos pentru a descƒÉrca fi»ôierele de examen pentru grupa ta</p>
                        </div>
                    </div>
                    <a 
                        id="downloadLink" 
                        href="#" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-cyan-700 transition shadow-lg hover:shadow-xl"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        DescarcƒÉ Fi»ôierele de Examen pentru Grupa <span id="groupName" class="font-bold"></span>
                    </a>
                </div>

                <!-- Exam Title -->
                <div>
                    <label for="examTitle" class="block text-sm font-medium text-gray-700 mb-2">
                        Titlul Examenului <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="examTitle" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="Introduce»õi titlul examenului"
                    >
                </div>

                <!-- File Upload -->
                <div>
                    <label for="examFile" class="block text-sm font-medium text-gray-700 mb-2">
                        Fi»ôier Examen <span class="text-red-500">*</span>
                        <span class="text-gray-500 text-xs">(.mp4, .mov, .mp3, .jpg, .png)</span>
                    </label>
                    <div class="mt-2 flex items-center justify-center w-full">
                        <label for="examFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500">
                                    <span class="font-semibold">ApasƒÉ pentru a √ÆncƒÉrca</span> sau trage »ôi plaseazƒÉ
                                </p>
                                <p class="text-xs text-gray-500">MP4, MOV, MP3, JPG, PNG (MAX. 50MB)</p>
                            </div>
                            <input 
                                id="examFile" 
                                type="file" 
                                accept=".mp4,.mov,.mp3,.jpg,.png"
                                required
                                class="hidden"
                            >
                        </label>
                    </div>
                    <div id="fileInfo" class="mt-2 hidden p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <span id="fileName" class="font-medium"></span>
                            <span id="fileSize" class="text-gray-500 ml-2"></span>
                        </p>
                    </div>
                </div>

                <!-- Performance Video/Audio Upload -->
                <div id="performanceUploadSection">
                    <label for="performanceFile" class="block text-sm font-medium text-gray-700 mb-2">
                        Video/Audio Interpretare Instrument <span id="performanceRequired" class="text-red-500">*</span>
                        <span class="text-gray-500 text-xs">(.mp3, .mp4, .mov)</span>
                        <span id="performanceOptional" class="text-gray-500 text-xs hidden">(Op»õional pentru Dirijor)</span>
                    </label>
                    <div class="mt-2 flex items-center justify-center w-full">
                        <label for="performanceFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500">
                                    <span class="font-semibold">ApasƒÉ pentru a √ÆncƒÉrca</span> sau trage »ôi plaseazƒÉ
                                </p>
                                <p class="text-xs text-gray-500">MP3, MP4, MOV (MAX. 50MB)</p>
                                <p class="text-xs text-gray-400 mt-1">FilmeazƒÉ cum c√¢n»õi/execu»õi la instrument</p>
                            </div>
                            <input 
                                id="performanceFile" 
                                type="file" 
                                accept=".mp3,.mp4,.mov"
                                class="hidden"
                            >
                        </label>
                    </div>
                    <div id="performanceFileInfo" class="mt-2 hidden p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <span id="performanceFileName" class="font-medium"></span>
                            <span id="performanceFileSize" class="text-gray-500 ml-2"></span>
                        </p>
                    </div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 rounded-lg font-semibold text-lg hover:from-amber-700 hover:to-orange-700 transition shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="submitBtnText">Trimite Examenul</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAV0_Buy_KKD4TSe-1IpByCVoZFoRJQaNE",
            authDomain: "mho-music-academy.firebaseapp.com",
            projectId: "mho-music-academy",
            storageBucket: "mho-music-academy.firebasestorage.app",
            messagingSenderId: "705322739069",
            appId: "1:705322739069:web:422b6fd0c7a08ab8921814",
            measurementId: "G-CF5HDVT6MK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Google Drive links for exam files by group
        const GROUP_TESTS = {
            G: "https://drive.google.com/drive/folders/1_9Uim86sqITRGqvmj70Obg7rCsMWq93p?dmr=1&ec=wgc-drive-hero-goto",
            B: "https://drive.google.com/drive/folders/1s3WT4Otxssxd4Cxs7pfbsyRqUrWEA5e2?dmr=1&ec=wgc-drive-hero-goto",
            V: "https://drive.google.com/drive/folders/1CkNDZUwmjb2Gh1UNV-_OOaFNno88ojjU?dmr=1&ec=wgc-drive-hero-goto",
            A: "https://drive.google.com/drive/folders/1U82pA65tG8xIoZkJY3b1Trd6krwVFhjp?dmr=1&ec=wgc-drive-hero-goto",
            Armonie: "https://drive.google.com/drive/folders/1pl7d0a2Ljl3OOXcg0YAnP_geCZZutVw2?dmr=1&ec=wgc-drive-hero-goto"
        };

        // DOM Elements
        const form = document.getElementById('examForm');
        const statusMessage = document.getElementById('statusMessage');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnText = document.getElementById('submitBtnText');
        const fileInput = document.getElementById('examFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const groupSelect = document.getElementById('group');
        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');
        const groupName = document.getElementById('groupName');
        const courseSelect = document.getElementById('course');
        const performanceFileInput = document.getElementById('performanceFile');
        const performanceFileInfo = document.getElementById('performanceFileInfo');
        const performanceFileName = document.getElementById('performanceFileName');
        const performanceFileSize = document.getElementById('performanceFileSize');
        const performanceRequired = document.getElementById('performanceRequired');
        const performanceOptional = document.getElementById('performanceOptional');
        const performanceUploadSection = document.getElementById('performanceUploadSection');

        // Show/hide download section based on group selection
        groupSelect.addEventListener('change', (e) => {
            const selectedGroup = e.target.value;
            if (selectedGroup && GROUP_TESTS[selectedGroup]) {
                downloadLink.href = GROUP_TESTS[selectedGroup];
                groupName.textContent = selectedGroup;
                downloadSection.classList.remove('hidden');
            } else {
                downloadSection.classList.add('hidden');
            }
        });

        // Show file info when file is selected
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.classList.remove('hidden');
            } else {
                fileInfo.classList.add('hidden');
            }
        });

        // Show performance file info when file is selected
        performanceFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                performanceFileName.textContent = file.name;
                performanceFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                performanceFileInfo.classList.remove('hidden');
            } else {
                performanceFileInfo.classList.add('hidden');
            }
        });

        // Update performance file requirement and visibility based on course
        courseSelect.addEventListener('change', (e) => {
            const selectedCourse = e.target.value;
            if (selectedCourse === 'Dirijor') {
                // Hide the entire performance upload section for Dirijor
                performanceUploadSection.classList.add('hidden');
                performanceFileInput.removeAttribute('required');
                // Clear any selected file
                performanceFileInput.value = '';
                performanceFileInfo.classList.add('hidden');
            } else {
                // Show the performance upload section for other courses
                performanceUploadSection.classList.remove('hidden');
                performanceFileInput.setAttribute('required', 'required');
                performanceRequired.classList.remove('hidden');
                performanceOptional.classList.add('hidden');
            }
        });

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
                'bg-blue-100 text-blue-800 border border-blue-300'
            }`;
            statusMessage.classList.remove('hidden');
        }

        // Hide status message
        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const course = document.getElementById('course').value;
            const group = document.getElementById('group').value;
            const examTitle = document.getElementById('examTitle').value.trim();
            const file = fileInput.files[0];
            const performanceFile = performanceFileInput.files[0];

            // Validate required fields
            if (!firstName || !lastName || !course || !group || !examTitle || !file) {
                showStatus('‚ö†Ô∏è VƒÉ rugƒÉm sƒÉ completa»õi toate c√¢mpurile obligatorii »ôi sƒÉ selecta»õi un fi»ôier.', 'error');
                return;
            }

            // Validate performance file requirement (required except for Dirijor)
            if (course !== 'Dirijor' && !performanceFile) {
                showStatus('‚ö†Ô∏è VƒÉ rugƒÉm sƒÉ √ÆncƒÉrca»õi video/audio cu interpretarea la instrument.', 'error');
                return;
            }

            // Validate file size (50MB max)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showStatus('‚ùå Dimensiunea fi»ôierului depƒÉ»ôe»ôte limita de 50MB. VƒÉ rugƒÉm sƒÉ √ÆncƒÉrca»õi un fi»ôier mai mic.', 'error');
                return;
            }

            if (performanceFile && performanceFile.size > maxSize) {
                showStatus('‚ùå Dimensiunea fi»ôierului video/audio depƒÉ»ôe»ôte limita de 50MB. VƒÉ rugƒÉm sƒÉ √ÆncƒÉrca»õi un fi»ôier mai mic.', 'error');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtnText.textContent = '‚è≥ Se √ÆncarcƒÉ...';

            try {
                showStatus('üì§ Se √ÆncarcƒÉ fi»ôierul √Æn Firebase Storage...', 'info');

                // Create storage reference: /exams/<group>/<filename>
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop();
                const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const storageRef = ref(storage, `exams/${group}/${fileName}`);

                // Upload file to Firebase Storage
                const snapshot = await uploadBytes(storageRef, file);
                showStatus('üîó Se ob»õine URL-ul fi»ôierului...', 'info');

                // Get download URL
                const fileURL = await getDownloadURL(snapshot.ref);

                // Upload performance file if provided
                let performanceFileURL = null;
                let performanceFileName = null;
                let performanceFileSize = null;
                let performanceFileType = null;

                if (performanceFile) {
                    showStatus('üì§ Se √ÆncarcƒÉ video/audio interpretare...', 'info');
                    
                    const performanceTimestamp = Date.now();
                    const performanceFileExtension = performanceFile.name.split('.').pop();
                    const performanceStorageFileName = `${performanceTimestamp}_${performanceFile.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    const performanceStorageRef = ref(storage, `exams/${group}/performance/${performanceStorageFileName}`);
                    
                    const performanceSnapshot = await uploadBytes(performanceStorageRef, performanceFile);
                    performanceFileURL = await getDownloadURL(performanceSnapshot.ref);
                    performanceFileName = performanceFile.name;
                    performanceFileSize = performanceFile.size;
                    performanceFileType = performanceFile.type;
                }

                showStatus('üíæ Se salveazƒÉ datele examenului...', 'info');

                // Save exam data to Firestore
                const examData = {
                    firstName,
                    lastName,
                    course,
                    group,
                    examTitle,
                    fileName: file.name,
                    fileURL,
                    fileSize: file.size,
                    fileType: file.type,
                    performanceFileURL: performanceFileURL || null,
                    performanceFileName: performanceFileName || null,
                    performanceFileSize: performanceFileSize || null,
                    performanceFileType: performanceFileType || null,
                    createdAt: new Date().toISOString(),
                    timestamp: new Date()
                };

                const docRef = await addDoc(collection(db, 'exams'), examData);

                // Success
                showStatus('‚úÖ Examen trimis cu succes! Fi»ôierul tƒÉu a fost √ÆncƒÉrcat »ôi salvat.', 'success');
                form.reset();
                fileInfo.classList.add('hidden');
                performanceFileInfo.classList.add('hidden');
                downloadSection.classList.add('hidden');
                // Reset performance file requirement
                performanceFileInput.removeAttribute('required');
                performanceRequired.classList.add('hidden');
                performanceOptional.classList.add('hidden');

                console.log('Exam saved with ID:', docRef.id);
                console.log('File URL:', fileURL);
            } catch (error) {
                console.error('Error submitting exam:', error);
                showStatus(`‚ùå Eroare: ${error.message}. VƒÉ rugƒÉm sƒÉ √Æncerca»õi din nou.`, 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Trimite Examenul';
            }
        });
    </script>
</body>
</html>
